

<div class="page-header">
  <h1>
    Заявления
    <small class="nowrap"><%= @entrant.full_name %></small>
  </h1>
</div>

<h2>Оформленные заявления</h2>

<table class="table table-striped table-condensed">
  <thead>
    <tr>
      <th class="text-muted">#</th>
      <th>Номер</th>
      <th>Направление</th>
      <th></th>
      <th>
        <%= link_to print_all_entrance_campaign_entrant_applications_path(@campaign, @entrant),
                    class: 'btn btn-info' do %>
          <span class="glyphicons print"></span>
        <% end %>
      </th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <% @applications.each do |a| %>
    <tr>
      <td class="text-muted"><%= a.id %></td>
      <td><%= a.number %></td>
      <td>
        <%= a.direction.new_code %>
        <%= a.direction.name %>
      </td>
      <td>
        <% if a.packed? %>
          <button class="btn btn-<%= a.original? ? 'success' : 'default' %>"
                  title="<%= a.original? ? 'Оригинал' : 'Копия' %> аттестата"
                  data-toggle="modal" data-target="#documents_packed">
            <% if a.original? %>
              <span class="glyphicons folder_flag"></span>
            <% else %>
              <span class="glyphicons folder_open"></span>
            <% end %>
          </button>

          <%= render partial: 'move_documents',
                     locals: {
                       from_application: a,
                       to_applications: @applications.reject { |x| x.id == a.id }
                     } %>
        <% end %>
      </td>
      <% if a.called_back? %>
        <td colspan="3">
          Отозвано.
        </td>
      <% else %>
        <td>
          <%= link_to print_entrance_campaign_entrant_application_path(@campaign, @entrant, a),
                      class: 'btn btn-default', title: 'Распечатать' do %>
            <span class="glyphicons print"></span>
          <% end %>
        </td>

        <td>
          <% if a.competitive_group_item.payed? %>
            <button class="btn btn-<%= a.contract ? 'success' : 'default' %>"
                    data-toggle="modal"
                    data-target="#<%= dom_id(a, 'contract') %>"
                    title="Договор об образовании"
                    disabled="disabled">
              <span class="glyphicons coins"></span>
            </button>
            <div class="modal fade" id="<%= dom_id(a, 'contract') %>">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                      <span aria-hidden="true">&times;</span>
                      <span class="sr-only">Закрыть</span>
                    </button>
                    <h4 class="modal-title">Договор об образовании</h4>
                  </div>
                  <% if a.contract %>
                    <div class="modal-body">
                      <p>
                        Договор № <%= a.contract.number %>
                        от <%= l a.contract.created_at %>.
                      </p>
                      <%= link_to 'Распечатать',
                                  entrance_campaign_entrant_application_contract_path(@campaign, @entrant, a, format: :pdf), target: :blank %>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-default"
                              data-dismiss="modal">
                        Закрыть
                      </button>
                      <%= link_to entrance_campaign_entrant_application_contract_path(@campaign, @entrant, a), method: :delete, class: 'btn btn-danger', data: { confirm: 'Вы уверены?' } do %>
                        Удалить договор
                      <% end %>
                    </div>
                <% else %>
                    <%= form_for a.build_contract,
                                 url: entrance_campaign_entrant_application_contract_path(@campaign, @entrant, a),
                                 html: { class: 'form-horizontal' } do |f| %>
                      <div class="modal-body">
                        <div class="form-group">
                          <div class="col-sm-offset-2 col-sm-10">
                            <div class="radio">
                              <label>
                                <%= f.radio_button :sides, :bilateral %>
                                Договор с совершеннолетним абитуриентом
                              </label>
                            </div>
                            <div class="radio">
                              <label>
                                <%= f.radio_button :sides, :trilateral %>
                                Договор с родителем/представителем абитуриента
                              </label>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-default"
                                data-dismiss="modal">
                          Закрыть
                        </button>
                        <%= f.submit 'Сформировать контракт',
                                     class: 'btn btn-primary' %>
                      </div>
                    <% end %>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </td>

        <td>
          <%= link_to entrance_campaign_entrant_application_path(@campaign, @entrant, a),
                      method: :delete, class: 'btn btn-danger',
                      title: 'Отозвать', data: { confirm: 'Вы уверены?' } do %>
            <span class="glyphicons remove_2"></span>
          <% end %>
        </td>
      <% end %>
    </tr>
  <% end %>
</table>

<% if Entrance::DocumentMovement.for_applications(@applications).any? %>
  <h2>Движение документов</h2>
  <table class="table table-striped">
    <thead>
      <tr>
        <th class="text-muted">#</th>
        <th>Дата</th>
        <th></th>
        <th></th>
      </tr>
    </thead>
    <% Entrance::DocumentMovement.for_applications(@applications).each do |m| %>
      <tr>
        <td class="text-muted"><%= m.id %></td>
        <td><%= l m.created_at %></td>
        <td><%= m.description %></td>
        <td></td>
      </tr>
    <% end %>
  </table>
<% end %>

<hr>

<% @new_applications.sort_by { |a|
     a.competitive_group_item.competitive_group.name }.each do |a| %>
    <% if a.entrant.ioo %>
        <% next unless a.competitive_group_item.distance? %>
    <% end %>
  <h4><%= a.competitive_group_item.competitive_group.name %></h4>

  <div id="<%= dom_id(a.competitive_group_item.competitive_group) %>">
    <% if a.id %>
      <%= render partial: 'application', locals: { application: a } %>
    <% else %>
      <%= render partial: 'form', locals: { application: a } %>
    <% end %>
  </div>
<% end %>

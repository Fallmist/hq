<div class="row">
  <div class="col-sm-12">
    <%= hidden_field_tag :campaign, url_for(params), class: 'hidden-pill-values', onchange: 'document.location = $(this).val();' %>
    <%= pill_tabs('campaign', [
      [rating_entrance_campaign_path(Entrance::Campaign::CURRENT, 
        direction: params[:direction], utf8: '✓',
        form: params[:form], payment: params[:payment]),
       Entrance::Campaign.find(Entrance::Campaign::CURRENT).name], 
      [crimea_rating_entrance_campaign_path(Entrance::Campaign::CRIMEA, 
        direction: params[:direction], utf8: '✓',
        form: params[:form], payment: params[:payment]),
        Entrance::Campaign.find(Entrance::Campaign::CRIMEA).name]
    ], 'campaign', class:  'super-tabs') %>
  </div>
</div>
<br>

<div class="page-header">
    <h1>Рейтинги и приказы о зачислении</h1>
</div>

<%= form_tag rating_entrance_campaign_path(@campaign), method: :get do %>
  <div class="row">
    <div class="col-sm-8">
      <%= select_tag :direction,
                     options_from_collection_for_select(
                       Direction.for_campaign(@campaign),
                       :id, :description, params[:direction]
                     ),
                     prompt: 'Все направления',
                     class: 'form-control',
                     onchange: %q($(this).parents('form').submit();) %>
    </div>
    <div class="col-sm-2">
      <%= select_tag :form,
                     options_for_select(
                       [['очная', 11], ['очно-заочная', 12], ['заочная', 10]],
                       params[:form]
                     ),
                     class: 'form-control',
                     onchange: %q($(this).parents('form').submit();) %>
    </div>
    <div class="col-sm-2">
      <%= select_tag :payment,
                     options_for_select(
                       [['бюджет', 14], ['платное', 15]],
                       params[:payment]
                     ), class: 'form-control',
                     onchange: %q($(this).parents('form').submit();) %>
    </div>
  </div>
<% end %>

<% if @items && @items.any? %>
  <% @items.each do |item| %>
    <%
       a_out_of_competition = []
       a_special_rights = []
       a_organization = []
       a_contest = []
       item.applications.for_rating.each do |a|
         if a.out_of_competition
           a_out_of_competition << a
         else
           if 0 != a.pass_min_score
             if a.special_rights
               a_special_rights << a
             elsif a.competitive_group_target_item
               a_organization << a
             else
               a_contest << a
             end
           end
         end
       end

       field_payment = item.payed? ? 'paid' : 'budget'
       field_form = case item.form
                      when 11 then 'o'
                      when 12 then 'oz'
                      when 10 then 'z'
                    end

       total_places = item.send("number_#{field_payment}_#{field_form}")
       total_places += item.send("number_quota_#{field_form}")
       item.competitive_group.target_organizations.each do |org|
         org.items.where(direction_id: item.direction_id, education_level_id: item.education_level_id).each do |i|
           total_places += i.send("number_target_#{field_form}")
         end
       end

       remaining_places = total_places
    %>

    <% if a_out_of_competition.any? %>
      <h2>Зачисленные без вступительных испытаний</h2>
      <table class="table table-striped table-bordered">
        <thead>
          <tr>
            <th></th>
            <th>Рег. номер</th>
            <th>Поступающий</th>
            <th>Основание</th>
            <th>Приказ о зачислении</th>
          </tr>
        </thead>
        <% a_out_of_competition.each_with_index do |a, i| %>
          <tr>
            <td><%= i + 1 %></td>
            <td class="nowrap"><%= a.number %></td>
            <td><%= a.entrant.full_name %></td>
            <td><%= a.benefits.first.temp_text %></td>
            <td class="nowrap">
              <% if a.order %>
                № <%= a.order.number %> от <%= l a.order.signing_date.to_date %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </table>
      <% remaining_places -= a_out_of_competition.size %>
    <% end %>

    <%
       exam_names = item.competitive_group.test_items.order(:entrance_test_priority).collect do |t|
         t.exam.name
       end
    %>

    <% if a_special_rights.any? %>
      <h2>Зачисленные по квоте приема лиц, имеющих особое право</h2>
      <table class="table table-striped table-bordered">
        <thead>
        <tr>
          <th></th>
          <th>Рег. номер</th>
          <th>Поступающий</th>
          <th>Приказ о зачислении</th>
        </tr>
        </thead>
        <% a_special_rights.sort(&Entrance::Application.sort_applications).each_with_index do |a, i| %>
          <tr>
            <td><%= i + 1 %></td>
            <td class="nowrap"><%= a.number %></td>
            <td><%= a.entrant.full_name %></td>
            <td class="nowrap">
              <% if a.order %>
                № <%= a.order.number %> от <%= l a.order.signing_date.to_date %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </table>
      <% remaining_places -= (a_special_rights.size > item.number_quota_o ? item.number_quota_o : a_special_rights.size) %>
    <% end %>

    <% if a_organization.any? %>
      <h2>Зачисленные по квоте целевого приема</h2>
      <% a_organization.group_by { |a| a.competitive_group_target_item }.each do |target_item, appls| %>
        <h2>Договор № <%= target_item.target_organization.contract_number %> от <%= l target_item.target_organization.contract_date %>, <%= target_item.target_organization.name %></h2>
        <table class="table table-striped table-bordered">
          <thead>
          <tr>
            <th></th>
            <th>Рег. номер</th>
            <th>Поступающий</th>
            <th>Приказ о зачислении</th>
          </tr>
          </thead>
          <% appls.sort(&Entrance::Application.sort_applications).each_with_index do |a, i| %>
            <tr>
              <td><%= i + 1 %></td>
              <td class="nowrap"><%= a.number %></td>
              <td><%= a.entrant.full_name %></td>
              <td class="nowrap">
                <% if a.order %>
                  № <%= a.order.number %> от <%= l a.order.signing_date.to_date %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </table>
        <% remaining_places -= (appls.size > target_item.number_target_o ? target_item.number_target_o : appls.size) %>
      <% end %>
      <br><br><br><br>
    <% end %>

    <% if a_contest.any? %>
      <% unless 12014 == @campaign.id %>
        <h2>
          Конкурсные списки на места в рамках контрольных цифр по общему
          конкурсу с выделением списков лиц, рекомендованных к зачислению
          на первом этапе
        </h2>
        <h3>
          <strong>
            Доступное количество мест — <%= remaining_places %>
          </strong>
          <% if item.payed? && 193593 != item.competitive_group.id %>
            <br>
            <span class="text-danger">
              <sup>*</sup> минимальный план приема, который может быть увеличен
            </span>
          <% end %>
        </h3>
      <% end %>

      <% if item.payed? %>
        <div class="alert alert-success">
          Зачисление на места по договорам об образовании производится после
          оформления договора и согласия на зачисление. Оригинал
          документа об образовании для зачисления не требуется.
        </div>
      <% end %>

      <div class="row">
        <div class="col-sm-12">
          <label>
            <input name="original" type="radio" checked onclick="$('.app').show();"> Все заявления
          </label>
          &nbsp;&nbsp;&nbsp;
          <label>
            <input name="original" type="radio" onclick="$('.app.original').show(); $('.app.without_original').hide();"> Только с оригиналом
          </label>
          &nbsp;&nbsp;&nbsp;
          <label>
            <input name="original" type="radio" onclick="$('.app.without_original').show(); $('.app.original').hide();"> Только без оригинала
          </label>
        </div>
      </div>

      <table class="table table-striped table-bordered">
        <thead>
        <tr>
          <th></th>
          <th>Рег. номер</th>
          <th>Поступающий</th>
          <% exam_names.each do |name| %>
            <th><%= name %></th>
          <% end %>
          <th>Сумма</th>
          <th>Оригинал</th>
          <% if can?(:manage, Entrance::Application) %>
            <th></th>
          <% end %>
        </tr>
        </thead>
        <% to_enroll = remaining_places %>
        <% last_found = false %>
        <% prev_score = 0 %>
        <% a_contest.sort(&Entrance::Application.sort_applications).each_with_index do |a, i| %>
          <% or_class = a.original? ? 'app original' : 'app without_original' %>

          <% if item.payed? %>
            <tr class="success <%= or_class %>">
          <% else %>
            <% if to_enroll > 0 %>
              <tr class="success <%= or_class %>">
              <% to_enroll -= 1 %>
              <% prev_score = a.total_score %>
            <% elsif 0 == to_enroll && !last_found %>
              <% # Огого. Совпали баллы. %>
              <% if prev_score == a.total_score %>
                <tr class="success <%= or_class %>">
              <% else %>
                <tr class="<%= or_class %>">
                <% last_found = true %>
              <% end %>
            <% else %>
              <tr class="<%= or_class %>">
            <% end %>
          <% end %>


            <td><%= i + 1 %></td>
            <td class="nowrap"><%= a.number %></td>
            <td><%= a.entrant.full_name %></td>
            <% a.abitexams.each do |exam| %>
              <td><%= exam.score %></td>
            <% end %>
            <td><%= a.total_score %></td>
            <td>
              <% if a.original? %>
                <span class="glyphicons ok_2"></span>
              <% end %>
            </td>
            <% if can?(:manage, Entrance::Application) %>
              <td>
                <%= link_to entrance_campaign_entrant_applications_path(@campaign, a.entrant),
                            class: 'btn btn-default',
                            title: 'Заявления',
                            target: :blank do %>
                  <span class="glyphicons notes"></span>
                <% end %>
              </td>
            <% end %>
          </tr>
        <% end %>
      </table>
    <% end %>
  <% end %>
<% else %>
  <p class="lead">По данному конкурсу не было найдено ни одного заявления</p>
<% end %>
